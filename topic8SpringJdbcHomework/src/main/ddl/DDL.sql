
--added 2 users in db: username: user role: ROLE_USER password: 111111 ,
--  username: bank role: ROLE_BANK_EMPLOYEE password: 222222 
--------------------------------------------------------
--  File created - Вторник-Март-15-2016   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Sequence DEMO_CUST_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "SOFTUNI"."DEMO_CUST_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 21 CACHE 20 NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Sequence DEMO_ORDER_ITEMS_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "SOFTUNI"."DEMO_ORDER_ITEMS_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 61 CACHE 20 NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Sequence DEMO_ORD_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "SOFTUNI"."DEMO_ORD_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 11 CACHE 20 NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Sequence DEMO_PROD_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "SOFTUNI"."DEMO_PROD_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 21 CACHE 20 NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Sequence DEMO_USERS_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "SOFTUNI"."DEMO_USERS_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 21 CACHE 20 NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Table TACCOUNT
--------------------------------------------------------

  CREATE TABLE "SOFTUNI"."TACCOUNT" 
   (	"ID" NUMBER, 
	"ACCOUNT_NO" VARCHAR2(50 BYTE), 
	"USERNAME" VARCHAR2(50 BYTE), 
	"AMOUNT" NUMBER(10,4), 
	"CREATED_BY" NUMBER, 
	"CURRENCY_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Table TCURRENCIES
--------------------------------------------------------

  CREATE TABLE "SOFTUNI"."TCURRENCIES" 
   (	"ID" NUMBER, 
	"NAME" VARCHAR2(20 BYTE), 
	"RATE" NUMBER(*,6)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Table TOPERATION
--------------------------------------------------------

  CREATE TABLE "SOFTUNI"."TOPERATION" 
   (	"ID" NUMBER, 
	"ACCOUNT_ID" NUMBER, 
	"OPERATION_TYPE_ID" NUMBER(1,0), 
	"AMOUNT" NUMBER(14,6), 
	"CURRENCY_ID" NUMBER(2,0), 
	"PERFORMED_BY_USER_ID" NUMBER(10,0)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Table TOPERATION_TYPE
--------------------------------------------------------

  CREATE TABLE "SOFTUNI"."TOPERATION_TYPE" 
   (	"ID" NUMBER, 
	"NAME" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Table TUSER
--------------------------------------------------------

  CREATE TABLE "SOFTUNI"."TUSER" 
   (	"ID" NUMBER, 
	"USERNAME" VARCHAR2(50 BYTE), 
	"PASSWORD" VARCHAR2(100 BYTE), 
	"ROLE" VARCHAR2(50 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
REM INSERTING into SOFTUNI.TACCOUNT
SET DEFINE OFF;
Insert into SOFTUNI.TACCOUNT (ID,ACCOUNT_NO,USERNAME,AMOUNT,CREATED_BY,CURRENCY_ID) values (3,'account2','user3',2158.824,1,2);
Insert into SOFTUNI.TACCOUNT (ID,ACCOUNT_NO,USERNAME,AMOUNT,CREATED_BY,CURRENCY_ID) values (1,'account1','user1',1600,1,1);
Insert into SOFTUNI.TACCOUNT (ID,ACCOUNT_NO,USERNAME,AMOUNT,CREATED_BY,CURRENCY_ID) values (2,'account2','user2',2158.824,2,2);
REM INSERTING into SOFTUNI.TCURRENCIES
SET DEFINE OFF;
Insert into SOFTUNI.TCURRENCIES (ID,NAME,RATE) values (1,'BGN',1);
Insert into SOFTUNI.TCURRENCIES (ID,NAME,RATE) values (2,'USD',1.7);
Insert into SOFTUNI.TCURRENCIES (ID,NAME,RATE) values (3,'EUR',1.9558);
REM INSERTING into SOFTUNI.TOPERATION
SET DEFINE OFF;
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (3,1,2,100,1,2);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (4,1,1,100,1,2);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (5,2,1,100,1,2);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (6,2,1,100,1,2);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (7,1,2,100,1,1);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (8,1,2,100,1,1);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (1,1,2,100,1,2);
Insert into SOFTUNI.TOPERATION (ID,ACCOUNT_ID,OPERATION_TYPE_ID,AMOUNT,CURRENCY_ID,PERFORMED_BY_USER_ID) values (2,1,2,100,1,2);
REM INSERTING into SOFTUNI.TOPERATION_TYPE
SET DEFINE OFF;
Insert into SOFTUNI.TOPERATION_TYPE (ID,NAME) values (1,'deposit');
Insert into SOFTUNI.TOPERATION_TYPE (ID,NAME) values (2,'withdraw');
REM INSERTING into SOFTUNI.TUSER
SET DEFINE OFF;
Insert into SOFTUNI.TUSER (ID,USERNAME,PASSWORD,ROLE) values (1,'user','96e79218965eb72c92a549dd5a330112','ROLE_USER');
Insert into SOFTUNI.TUSER (ID,USERNAME,PASSWORD,ROLE) values (2,'bank','e3ceb5881a0a1fdaad01296d7554868d','ROLE_BANK_EMPLOYEE');
--------------------------------------------------------
--  DDL for Index ACCOUNT_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "SOFTUNI"."ACCOUNT_PK" ON "SOFTUNI"."TACCOUNT" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Index TCURRENCIES_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "SOFTUNI"."TCURRENCIES_PK" ON "SOFTUNI"."TCURRENCIES" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Index TOPERATION_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "SOFTUNI"."TOPERATION_PK" ON "SOFTUNI"."TOPERATION" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Index TOPERATION_TYPE_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "SOFTUNI"."TOPERATION_TYPE_PK" ON "SOFTUNI"."TOPERATION_TYPE" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  DDL for Index TABLE1_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "SOFTUNI"."TABLE1_PK" ON "SOFTUNI"."TUSER" ("ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067" ;
--------------------------------------------------------
--  Constraints for Table TACCOUNT
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TACCOUNT" ADD CONSTRAINT "ACCOUNT_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067"  ENABLE;
  ALTER TABLE "SOFTUNI"."TACCOUNT" MODIFY ("ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table TCURRENCIES
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TCURRENCIES" MODIFY ("NAME" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TCURRENCIES" MODIFY ("RATE" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TCURRENCIES" ADD CONSTRAINT "TCURRENCIES_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067"  ENABLE;
  ALTER TABLE "SOFTUNI"."TCURRENCIES" MODIFY ("ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table TOPERATION
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TOPERATION" ADD CONSTRAINT "TOPERATION_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067"  ENABLE;
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("PERFORMED_BY_USER_ID" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("CURRENCY_ID" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("AMOUNT" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("OPERATION_TYPE_ID" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("ACCOUNT_ID" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION" MODIFY ("ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table TOPERATION_TYPE
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TOPERATION_TYPE" ADD CONSTRAINT "TOPERATION_TYPE_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067"  ENABLE;
  ALTER TABLE "SOFTUNI"."TOPERATION_TYPE" MODIFY ("NAME" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TOPERATION_TYPE" MODIFY ("ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table TUSER
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TUSER" MODIFY ("ROLE" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TUSER" MODIFY ("PASSWORD" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TUSER" MODIFY ("USERNAME" NOT NULL ENABLE);
  ALTER TABLE "SOFTUNI"."TUSER" ADD CONSTRAINT "USER_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "APEX_4778719555051067"  ENABLE;
  ALTER TABLE "SOFTUNI"."TUSER" MODIFY ("ID" NOT NULL ENABLE);
--------------------------------------------------------
--  Ref Constraints for Table TACCOUNT
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TACCOUNT" ADD CONSTRAINT "TACCOUNT_CURRENCIES_FK2" FOREIGN KEY ("CURRENCY_ID")
	  REFERENCES "SOFTUNI"."TCURRENCIES" ("ID") ENABLE;
  ALTER TABLE "SOFTUNI"."TACCOUNT" ADD CONSTRAINT "TACCOUNT_USER_FK1" FOREIGN KEY ("CREATED_BY")
	  REFERENCES "SOFTUNI"."TUSER" ("ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table TOPERATION
--------------------------------------------------------

  ALTER TABLE "SOFTUNI"."TOPERATION" ADD CONSTRAINT "TOPERATION_OPERATION_TYPE_FK" FOREIGN KEY ("OPERATION_TYPE_ID")
	  REFERENCES "SOFTUNI"."TOPERATION_TYPE" ("ID") ENABLE;
  ALTER TABLE "SOFTUNI"."TOPERATION" ADD CONSTRAINT "TOPERATION_TACCOUNT_FK" FOREIGN KEY ("ACCOUNT_ID")
	  REFERENCES "SOFTUNI"."TACCOUNT" ("ID") ENABLE;
  ALTER TABLE "SOFTUNI"."TOPERATION" ADD CONSTRAINT "TOPERATION_TCURRENCY_FK" FOREIGN KEY ("CURRENCY_ID")
	  REFERENCES "SOFTUNI"."TCURRENCIES" ("ID") ENABLE;
--------------------------------------------------------
--  DDL for Function CUSTOM_AUTH
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "SOFTUNI"."CUSTOM_AUTH" (p_username in VARCHAR2, p_password in VARCHAR2)
return BOOLEAN
is
  l_password varchar2(4000);
  l_stored_password varchar2(4000);
  l_expires_on date;
  l_count number;
begin
-- First, check to see if the user is in the user table
select count(*) into l_count from demo_users where user_name = p_username;
if l_count > 0 then
  -- First, we fetch the stored hashed password & expire date
  select password, expires_on into l_stored_password, l_expires_on
   from demo_users where user_name = p_username;

  -- Next, we check to see if the user's account is expired
  -- If it is, return FALSE
  if l_expires_on > sysdate or l_expires_on is null then

    -- If the account is not expired, we have to apply the custom hash
    -- function to the password
    l_password := custom_hash(p_username, p_password);

    -- Finally, we compare them to see if they are the same and return
    -- either TRUE or FALSE
    if l_password = l_stored_password then
      return true;
    else
      return false;
    end if;
  else
    return false;
  end if;
else
  -- The username provided is not in the DEMO_USERS table
  return false;
end if;
end;

/
--------------------------------------------------------
--  DDL for Function CUSTOM_HASH
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "SOFTUNI"."CUSTOM_HASH" (p_username in varchar2, p_password in varchar2)
return varchar2
is
  l_password varchar2(4000);
  l_salt varchar2(4000) := 'DPQMZ6C2PGABNHX4RXW69M7WLD1QUS';
begin

-- This function should be wrapped, as the hash algorhythm is exposed here.
-- You can change the value of l_salt or the method of which to call the
-- DBMS_OBFUSCATOIN toolkit, but you much reset all of your passwords
-- if you choose to do this.

l_password := utl_raw.cast_to_raw(dbms_obfuscation_toolkit.md5
  (input_string => p_password || substr(l_salt,10,13) || p_username ||
    substr(l_salt, 4,10)));
return l_password;
end;

/
